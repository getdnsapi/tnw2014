#
# an example of using getdns to pull out a TLSA record,
# extract a certificate, extract the public key, and then
# encrypt some text
#


import getdns
import M2Crypto as m2
from M2Crypto import RSA
import sys

tls_name = '77fa5113ab6a532ce2e6901f3bd3351c0db5845e0b1b5fb09907808d._smimecert.getdnsapi.org'


def get_first_secure_response(results):
    replies_tree = results['replies_tree']
    if (not replies_tree) or (not len(replies_tree)) or (not replies_tree[0]['answer']) or (not len(replies_tree[0]['answer'])):
        print 'empty answer list'
        return None
    else:
        reply = replies_tree[0]
        if reply['dnssec_status'] != getdns.DNSSEC_SECURE:
            print 'insecure reply'
            return None
        answer = replies_tree[0]['answers']
        record = [ x for x in answers if x['type'] is getdns.GETDNS_RRTYPE_TLSA ]
        if len(record) == 0:
            print 'no answers of type TLSA'
            return None
        return record[0]
    


cert =  resp['replies_tree'][0]['answer'][0]['rdata']['certificate_association_data']

x509 = m2.X509.load_cert_der_string(cert)
rsakey = x509.get_pubkey().get_rsa()
encrypted = rsakey.public_encrypt("A chunk of text", RSA.pkcs1_oaep_padding)
print encrypted.encode('base64')

def main():
    c = getdns.context_create()
    extensions = { 'dnssec_return_status' : getdns.GETDNS_EXTENSION_TRUE }
    results = getdns.general(c, tls_name, getdns.GETDNS_RRTYPE_TLSA, extensions=ext)
    if results['status'] == getdns.GETDNS_RESPSTATUS_GOOD:
        record = get_first_secure_response(results)


if __name__ == '__main__':
    main()
